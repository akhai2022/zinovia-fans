# Media and derived variants

## Variants

| Variant | Max dimension | Typical use |
|---------|----------------|-------------|
| `thumb` | 200px          | Thumbnails, lists |
| `grid`  | 600px          | Grid layout, cards |
| `full`  | 1200px         | Full-size view |

Derived variants are generated by the worker after upload. Originals are never modified.

## Watermark configuration

Footer watermark is applied only to **derived** variants (not originals), and only when enabled and for variants in the list.

| Env var | Default | Description |
|---------|---------|-------------|
| `MEDIA_WATERMARK_TEXT` | `Published on Zinovia-Fans` | Watermark text (do not use "Validated"). |
| `MEDIA_WATERMARK_ENABLED` | `false` (local), recommend `true` in staging/prod | Enable footer watermark on derived variants. |
| `MEDIA_WATERMARK_VARIANTS` | `grid,full` | Comma-separated list: `thumb`, `grid`, `full`. |
| `MEDIA_WATERMARK_HEIGHT_PCT` | `0.08` | Footer height as fraction of image (clamped 0.05–0.12). |
| `MEDIA_WATERMARK_OPACITY` | `0.55` | Background strip opacity (0–1). |
| `MEDIA_WATERMARK_BG` | `true` | Draw semi-transparent background strip. |
| `MEDIA_WATERMARK_PADDING_PCT` | `0.04` | Padding as fraction of smaller dimension. |
| `MEDIA_WATERMARK_TEXT_ALIGN` | `left` | `left` or `center`. |
| `MEDIA_WATERMARK_INCLUDE_HANDLE` | `false` | If true, append `@handle` when available. |

### Enabling in staging/production

Set in your environment (e.g. ECS task definition, `.env`):

```bash
MEDIA_WATERMARK_ENABLED=true
MEDIA_WATERMARK_VARIANTS=grid,full
# Optional: MEDIA_WATERMARK_TEXT="Published on Zinovia-Fans"
```

Default text is **"Published on Zinovia-Fans"** — do not use wording that implies certification or endorsement (e.g. "Validated by …").

### After changing watermark config

Derived assets are generated once per (parent_asset_id, variant). Changing config does **not** auto-regenerate existing derived images. To apply new watermark settings to existing media, run a reprocess command or re-trigger variant generation for the affected assets.

## Download URL with variant

- **GET /media/{media_id}/download-url?variant=thumb|grid|full**  
  Returns a signed URL for the requested variant if it exists; otherwise the original asset URL.  
  Access control is unchanged (e.g. owner-only where applicable).

### Verify

1. Upload an image and note the returned `asset_id`.
2. Wait for the worker to generate variants (or trigger the task).
3. Request a variant URL:
   ```bash
   curl -s -b cookies.txt "http://localhost:8000/media/<asset_id>/download-url?variant=grid"
   ```
4. Open the returned `download_url` in a browser; the image should show the derived variant (and watermark if enabled for `grid`).

## Video (MVP: MP4 only)

- **Upload**: Allowed when `MEDIA_ALLOW_VIDEO=true`. Only `video/mp4`; max size `MEDIA_MAX_VIDEO_BYTES` (default 200MB). Validation at `POST /media/upload-url`.
- **Posts**: Create with `type=VIDEO` and `asset_ids=[<video_asset_id>]`. First asset must be `video/mp4`.
- **Poster**: Optional thumbnail from one frame. Set `MEDIA_VIDEO_POSTER_ENABLED=true`. Worker task `media.generate_video_poster` is enqueued when a VIDEO post is created. Poster stored as derived variant `poster` at `media/<asset_id>/poster.webp`.
- **Download**: `GET /media/{id}/download-url` returns video URL (access: owner or viewer who can see a post containing this asset). `?variant=poster` returns poster URL when present, else 404.

## Database

- **media_assets**: original uploads; `object_key` is never overwritten by variant generation.
- **media_derived_assets**: one row per (parent_asset_id, variant) with `object_key` pointing to the derived file (e.g. `derived/..._grid.jpg`, or `media/<id>/poster.webp` for video poster).
