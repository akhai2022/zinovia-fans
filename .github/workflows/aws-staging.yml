# Auto-deploy to AWS production on push to main.
# Tests run first; deploy only proceeds if tests pass.
# Requires: GitHub OIDC provider in AWS and AWS_ROLE_ARN_PROD secret.

name: AWS Deploy

on:
  workflow_dispatch:
  # TEMPORARILY DISABLED â€” re-enable push trigger when ready
  # push:
  #   branches: [main]
  #   paths:
  #     - 'apps/**'
  #     - 'packages/**'
  #     - 'infra/docker/**'
  #     - 'infra/aws/**'
  #     - '.github/workflows/aws-staging.yml'

env:
  AWS_REGION: us-east-1
  CLUSTER: zinovia-fans-prod-cluster
  API_SERVICE: zinovia-fans-prod-api
  WEB_SERVICE: zinovia-fans-prod-web
  WORKER_SERVICE: zinovia-fans-prod-worker

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Prepare env
        run: cp .env.example .env

      - name: Build backend images
        run: docker compose --env-file .env -f infra/compose/docker-compose.yml build api worker

      - name: Start infrastructure
        run: |
          docker compose --env-file .env -f infra/compose/docker-compose.yml up -d \
            postgres redis minio mailpit \
            --wait --wait-timeout 120
          docker compose --env-file .env -f infra/compose/docker-compose.yml run --rm minio-init

      - name: Start API and worker
        run: |
          docker compose --env-file .env -f infra/compose/docker-compose.yml up -d api worker \
            --wait --wait-timeout 120

      - name: Show logs on failure
        if: failure()
        run: docker compose --env-file .env -f infra/compose/docker-compose.yml logs --tail=200

      - name: Migrate
        run: make migrate

      - name: API lint
        run: make api-lint

      - name: API typecheck
        run: make api-typecheck

      - name: API tests
        run: make api-test

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install web dependencies
        run: npm ci

      - name: Web build
        run: npm --prefix apps/web run build
        env:
          NEXT_PUBLIC_API_BASE_URL: http://localhost:8000

  deploy:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ECR login
        run: |
          AWS_ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com

      - name: Build and push API
        run: |
          AWS_ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
          REG="${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          docker build -f infra/docker/api/Dockerfile -t $REG/zinovia-fans-prod-api:$GITHUB_SHA -t $REG/zinovia-fans-prod-api:latest .
          docker push $REG/zinovia-fans-prod-api:$GITHUB_SHA
          docker push $REG/zinovia-fans-prod-api:latest

      - name: Build and push Web
        run: |
          AWS_ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
          REG="${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          docker build -f infra/docker/web/Dockerfile \
            --build-arg NEXT_PUBLIC_API_BASE_URL=https://api.zinovia.ai \
            --build-arg NEXT_PUBLIC_API_SAME_ORIGIN_PROXY=true \
            --build-arg NEXT_PUBLIC_APP_URL=https://zinovia.ai \
            -t $REG/zinovia-fans-prod-web:$GITHUB_SHA -t $REG/zinovia-fans-prod-web:latest .
          docker push $REG/zinovia-fans-prod-web:$GITHUB_SHA
          docker push $REG/zinovia-fans-prod-web:latest

      - name: Build and push Worker
        run: |
          AWS_ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
          REG="${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          docker build -f infra/docker/worker/Dockerfile -t $REG/zinovia-fans-prod-worker:$GITHUB_SHA -t $REG/zinovia-fans-prod-worker:latest .
          docker push $REG/zinovia-fans-prod-worker:$GITHUB_SHA
          docker push $REG/zinovia-fans-prod-worker:latest

      - name: Force ECS deployment
        run: |
          aws ecs update-service --cluster ${{ env.CLUSTER }} --service ${{ env.API_SERVICE }} --force-new-deployment --region ${{ env.AWS_REGION }}
          aws ecs update-service --cluster ${{ env.CLUSTER }} --service ${{ env.WEB_SERVICE }} --force-new-deployment --region ${{ env.AWS_REGION }}
          aws ecs update-service --cluster ${{ env.CLUSTER }} --service ${{ env.WORKER_SERVICE }} --force-new-deployment --region ${{ env.AWS_REGION }}

      - name: Run migration (one-off task)
        run: |
          SUBNETS=$(aws ecs describe-services --cluster ${{ env.CLUSTER }} --services ${{ env.API_SERVICE }} --query 'services[0].networkConfiguration.awsvpcConfiguration.subnets' --output text --region ${{ env.AWS_REGION }} | tr '\t' ',')
          SG=$(aws ecs describe-services --cluster ${{ env.CLUSTER }} --services ${{ env.API_SERVICE }} --query 'services[0].networkConfiguration.awsvpcConfiguration.securityGroups[0]' --output text --region ${{ env.AWS_REGION }})
          aws ecs run-task --cluster ${{ env.CLUSTER }} --task-definition zinovia-fans-prod-api --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[$SUBNETS],securityGroups=[$SG],assignPublicIp=DISABLED}" \
            --overrides '{"containerOverrides":[{"name":"api","command":["sh","-c","cd /app/apps/api && alembic upgrade head"]}]}' \
            --region ${{ env.AWS_REGION }}
        continue-on-error: true
